<!DOCTYPE html>
<html>
<head>
    <title>Moonrise Calculator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #map {
            flex-grow: 1;
        }
        .container {
            padding: 10px;
            background-color: #f8f9fa;
        }
        .moon-icon {
            font-size: 20px;
            background: none;
            border: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ë‹¬ ëœ¨ëŠ” ìœ„ì¹˜ ì‹œë®¬ë ˆì´í„°</h1>
    <form id="location-form" class="row g-3 align-items-center">
        <div class="col-auto">
            <label for="lat" class="form-label">ìœ„ë„</label>
            <input type="text" class="form-control" id="lat" placeholder="ì˜ˆ: 37.5665" value="37.5665">
        </div>
        <div class="col-auto">
            <label for="lon" class="form-label">ê²½ë„</label>
            <input type="text" class="form-control" id="lon" placeholder="ì˜ˆ: 126.9780" value="126.9780">
        </div>
        <div class="col-auto">
            <label for="elevation" class="form-label">ê³ ë„(m)</label>
            <input type="number" class="form-control" id="elevation" placeholder="ì˜ˆ: 0" value="0">
        </div>
        <div class="col-auto">
            <label for="date" class="form-label">ë‚ ì§œ</label>
            <input type="date" class="form-control" id="date">
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary">ê³„ì‚°</button>
        </div>
    </form>
    <div id="result" class="mt-3"></div>
</div>

<div id="map"></div>

<script>
    // Set default date to today
    document.getElementById('date').valueAsDate = new Date();

    var map = L.map('map').setView([37.5665, 126.9780], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var layers = L.layerGroup().addTo(map);
    var rightClickMarker;

    map.on('contextmenu', function(e) {
        var lat = e.latlng.lat.toFixed(6);
        var lon = e.latlng.lng.toFixed(6);

        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;

        if (rightClickMarker) {
            map.removeLayer(rightClickMarker);
        }
        rightClickMarker = L.marker(e.latlng).addTo(map)
            .bindPopup(`ì„ íƒëœ ìœ„ì¹˜<br>ìœ„ë„: ${lat}<br>ê²½ë„: ${lon}`)
            .openPopup();
    });

    document.getElementById('location-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        if (rightClickMarker) {
            map.removeLayer(rightClickMarker);
        }
        layers.clearLayers();

        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;
        const date = document.getElementById('date').value;
        const elevation = document.getElementById('elevation').value;
        const resultDiv = document.getElementById('result');

        if (!lat || !lon || !date) {
            resultDiv.innerHTML = `<div class="alert alert-danger">ìœ„ë„, ê²½ë„, ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
            return;
        }

        resultDiv.innerHTML = `<div class="alert alert-info">ê³„ì‚° ì¤‘...</div>`;

        fetch('/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ lat, lon, date, elevation }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }

            const location = data.location;
            map.setView([location.lat, location.lon], 12);

            let resultHtml = '<div class="card"><div class="card-body">';
            if (data.moon_phase) {
                resultHtml += `
                    <h5 class="card-title">ë‹¬ ì •ë³´ (${data.date})</h5>
                    <p class="card-text">
                        <strong>ìœ„ìƒ:</strong> ${data.moon_phase.name_korean} (ë°ê¸°: ${data.moon_phase.illumination.toFixed(1)}%)
                    </p>
                `;
            }
            if (data.moonrise_time_kst) {
                resultHtml += `
                    <p class="card-text">
                        <strong>ì›”ì¶œ:</strong> ${data.moonrise_time_kst} (KST), <strong>ë°©ìœ„ê°:</strong> ${data.moonrise_azimuth.toFixed(2)}Â°
                    </p>
                `;
            }
            if (data.moonset_time_kst) {
                resultHtml += `
                    <p class="card-text">
                        <strong>ì›”ëª°:</strong> ${data.moonset_time_kst} (KST), <strong>ë°©ìœ„ê°:</strong> ${data.moonset_azimuth.toFixed(2)}Â°
                    </p>
                `;
            }
            if (!data.moonrise_time_kst && !data.moonset_time_kst) {
                 resultHtml += `<p class="card-text">í•´ë‹¹ ë‚ ì§œì— ì›”ì¶œ/ì›”ëª° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
            resultHtml += '</div></div>';
            resultDiv.innerHTML = resultHtml;


            const popup_text = `<b>í˜„ì¬ ìœ„ì¹˜</b>`;
            L.marker([location.lat, location.lon])
                .addTo(layers)
                .bindPopup(popup_text)
                .bindTooltip("í˜„ì¬ ìœ„ì¹˜")
                .openPopup();

            if(data.hourly_positions) {
                data.hourly_positions.forEach((pos, i) => {
                    // ë‹¬ì˜ ê°€ì‹œì„±ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
                    const isVisible = pos.altitude > 0;
                    const line_color = isVisible ? (i === 0 ? "red" : "orange") : "gray";
                    const line_weight = isVisible ? (i === 0 ? 5 : 3) : 2;
                    const line_opacity = isVisible ? 1.0 : 0.5;

                    L.polyline(
                        [[location.lat, location.lon], [pos.dest_lat, pos.dest_lon]],
                        { 
                            color: line_color, 
                            weight: line_weight,
                            opacity: line_opacity,
                            dashArray: isVisible ? null : '5, 5'  // ì§€í‰ì„  ì•„ë˜ì¼ ë•Œ ì ì„ ìœ¼ë¡œ í‘œì‹œ
                        }
                    ).addTo(layers)
                    .bindTooltip(`<b>ì‹œê°„: ${pos.time} (KST)</b><br>ë°©ìœ„ê°: ${pos.azimuth.toFixed(2)}Â°<br>ê³ ë„: ${pos.altitude.toFixed(2)}Â°<br>${isVisible ? 'ë‹¬ì´ ë³´ì„' : 'ë‹¬ì´ ì§€í‰ì„  ì•„ë˜'}`);

                    // ë‹¬ ì•„ì´ì½˜ - ê°€ì‹œì„±ì— ë”°ë¼ ë‹¤ë¥¸ ì•„ì´ì½˜ ì‚¬ìš©
                    const moonEmoji = isVisible ? 'ğŸŒ•' : 'ğŸŒ‘';  // ë³´ì¼ ë•ŒëŠ” ë°ì€ ë‹¬, ì•ˆ ë³´ì¼ ë•ŒëŠ” ì–´ë‘ìš´ ë‹¬
                    const iconOpacity = isVisible ? 1.0 : 0.4;
                    
                    var moonIcon = L.divIcon({
                        html: `<span style="opacity: ${iconOpacity};">${moonEmoji}</span>`,
                        className: 'moon-icon',
                        iconSize: [50, 50],
                    });
                    L.marker([pos.dest_lat, pos.dest_lon], { icon: moonIcon }).addTo(layers);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.innerHTML = `<div class="alert alert-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        });
    });
</script>

</body>
</html>